<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="Project" content="Final Project Application">
  <meta name="AroundTheWorld">

  <title>Around The World</title>

  <link rel="icon" type="image/png" href="/static/images/favicon.png"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin="" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="/static/styles.css">

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>

<body>
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col" style="text-align: center;">
        <img class="logo" src="/static/images/logo_transparent.png"/>
      </div>
    </div>
    <div class="row align-items-center mb-2">
      <div class="col">
        <h4 class="text-center">Pick a location you like on the map below</h4>
      </div>
      <div class="col">
        <h4 class="text-center" id="message">These are the top 100 locations with the most similar climate to the one
          you picked for the month of January!</h4>
      </div>
    </div>
    <div class="row mb-4">
      <div class="col">
        <div id="mapid"></div>
      </div>
      <div class="col">
        <div id="mapid2"></div>
      </div>
    </div>
    <div class="row justify-content-center">
      <div class="btn-group btn-group-toggle" data-toggle="buttons">
        <label class="btn btn-outline-dark active">
          <input type="radio" name="options" id="option1" value=1 onclick="onClick(true)" autocomplete="off" checked>Jan
        </label>
        <label class="btn btn-outline-dark">
          <input type="radio" name="options" id="option2" value=2 onclick="onClick(true)" autocomplete="off">Feb
        </label>
        <label class="btn btn-outline-dark">
          <input type="radio" name="options" id="option3" value=3 onclick="onClick(true)" autocomplete="off">Mar
        </label>
        <label class="btn btn-outline-dark">
          <input type="radio" name="options" id="option4" value=4 onclick="onClick(true)" autocomplete="off">Apr
        </label>
        <label class="btn btn-outline-dark">
          <input type="radio" name="options" id="option5" value=5 onclick="onClick(true)" autocomplete="off">May
        </label>
        <label class="btn btn-outline-dark">
          <input type="radio" name="options" id="option6" value=6 onclick="onClick(true)" autocomplete="off">Jun
        </label>
        <label class="btn btn-outline-dark">
          <input type="radio" name="options" id="option7" value=7 onclick="onClick(true)" autocomplete="off">Jul
        </label>
        <label class="btn btn-outline-dark">
          <input type="radio" name="options" id="option8" value=8 onclick="onClick(true)" autocomplete="off">Aug
        </label>
        <label class="btn btn-outline-dark">
          <input type="radio" name="options" id="option9" value=9 onclick="onClick(true)" autocomplete="off">Sep
        </label>
        <label class="btn btn-outline-dark">
          <input type="radio" name="options" id="option10" value=10 onclick="onClick(true)" autocomplete="off">Oct
        </label>
        <label class="btn btn-outline-dark">
          <input type="radio" name="options" id="option11" value=11 onclick="onClick(true)" autocomplete="off">Nov
        </label>
        <label class="btn btn-outline-dark">
          <input type="radio" name="options" id="option12" value=12 onclick="onClick(true)" autocomplete="off">Dec
        </label>
      </div>
    </div>
  </div>

  <script>
    // load data from Flask
    var allStations = JSON.parse('{{data|tojson}}');

    // create first map
    var map1 = L.map("mapid");

    // attribution link
    mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';

    // add OpenStreetMap Tile layer to map1
    L.tileLayer(
      "http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; " + mapLink + " Contributors"
    }).addTo(map1);

    // create marker cluster group for map1
    var cluster1 = L.markerClusterGroup({ disableClusteringAtZoom: 8 });

    // add markers to cluster1
    for (var i = 0; i < allStations.length; i++) {
      marker = new L.marker([allStations[i][2], allStations[i][3]])
        .bindPopup("<b>" + allStations[i][1] + "</b><br>Latitude: " + allStations[i][2].toFixed(2) + "<br>Longitude: "
          + allStations[i][3].toFixed(2) + "<br>Elevation: " + allStations[i][4].toFixed(2),
          {autoPan: false, autoClose: false, closeButton: false, closeOnClick: false})
        .on("click", onClick)
        .on("mouseover", showPopup)
        .on("mouseout", hidePopup);
      marker.station = allStations[i][0];
      cluster1.addLayer(marker);
    }

    // add cluster to map1
    map1.addLayer(cluster1);

    // create separate marker cluster group just for selected marker and add to map1
    var selectedMarker;
    var selectedCluster = L.markerClusterGroup({ disableClusteringAtZoom: 8 });
    map1.addLayer(selectedCluster);

    // initialize map1's view
    map1.setView(new L.LatLng(0, 0), 1.5);

    // create second map
    var map2 = L.map("mapid2");

    // add OpenStreetMap Tile layer to map2
    L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; " + mapLink + " Contributors"
    }).addTo(map2);

    // initialize map2's view
    map2.setView(new L.LatLng(0, 0), 1.5);

    // onClick function
    function onClick(fromMonthSelection) {
      var monthNum = $("input:radio[name=options]:checked").val();
      var monthText;
      if (monthNum == 1) {
        monthText = "January";
      } else if (monthNum == 2) {
        monthText = "February";
      } else if (monthNum == 3) {
        monthText = "March";
      } else if (monthNum == 4) {
        monthText = "April";
      } else if (monthNum == 5) {
        monthText = "May";
      } else if (monthNum == 6) {
        monthText = "June";
      } else if (monthNum == 7) {
        monthText = "July";
      } else if (monthNum == 8) {
        monthText = "August";
      } else if (monthNum == 9) {
        monthText = "September";
      } else if (monthNum == 10) {
        monthText = "October";
      } else if (monthNum == 11) {
        monthText = "November";
      } else if (monthNum == 12) {
        monthText = "December";
      }

      if (fromMonthSelection == true) {
        $("#message").text("These are the top 100 locations with the most similar climate to the one you picked for"
            + " the month of " + monthText + "!");
      } else {
        map1.eachLayer(function(layer) {
          layer.closePopup();
        });
        if (this != selectedMarker) {
          if (!!selectedMarker) {
            selectedCluster.removeLayer(selectedMarker);
            cluster1.addLayer(selectedMarker);
          }
          cluster1.removeLayer(this);
          selectedCluster.addLayer(this);
        }
        this.openPopup();
        selectedMarker = this;
      }

      // redraw map2
      if (!!selectedMarker) {
        $.getJSON("/similarity?station=" + selectedMarker.station + "&month=" + monthNum + "&limit=" + 100,
          function (data) {
            var similarStations = data["stations"];

            // remove all layers from map2
            map2.eachLayer(function (layer) {
              map2.removeLayer(layer);
            });

            // add OpenStreetMap Tile layer to map2
            L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution: "&copy; " + mapLink + " Contributors"
            }).addTo(map2);

            // add markers to cluster2
            var markerArray2 = [];
            for (var i = 0; i < similarStations.length; i++) {
              marker2 = new L.marker([similarStations[i][2], similarStations[i][3]])
                .bindTooltip("<b>" + similarStations[i][1] + "</b><br>Latitude: " + similarStations[i][2].toFixed(2)
                  + "<br>Longitude: " + similarStations[i][3].toFixed(2) + "<br>Elevation: "
                  + similarStations[i][4].toFixed(2) + "<br>Similarity: " + similarStations[i][5].toFixed(2));
              markerArray2.push(marker2);
            }
            var group2 = L.featureGroup(markerArray2).addTo(map2);
            try {
              map2.fitBounds(group2.getBounds());
            } catch (err) {
              map2.setView(new L.LatLng(0, 0), 1);
            }
          });
      }
    }

    function showPopup() {
      this.openPopup();
    }

    function hidePopup() {
      if (this != selectedMarker) {
        this.closePopup();
      }
    }
  </script>
</body>

</html>
